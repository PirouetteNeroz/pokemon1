<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panier Carameche</title>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .cart-item-image {
            width: 50px;
            height: 50px;
            cursor: pointer;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <v-app>
            <v-snackbar v-model="snackbar.show" :color="snackbar.color" timeout="3000">
                {{ snackbar.message }}
                <template v-slot:action="{ attrs }">
                    <v-btn text v-bind="attrs" @click="snackbar.show = false">Fermer</v-btn>
                </template>
            </v-snackbar>

            <v-app-bar app color="primary" dark>
                <v-toolbar-title>
                    <a href="/inventory.html" style="text-decoration: none; color: inherit;">
                        <v-btn text>Carameche</v-btn>
                    </a>
                </v-toolbar-title>
                <v-spacer></v-spacer>
                <v-text-field
                    v-model="searchQuery"
                    label="Rechercher..."
                    prepend-icon="mdi-magnify"
                    outlined
                    dense
                    hide-details
                    class="mr-4"
                ></v-text-field>
                <a href="/inventory.html" style="text-decoration: none; color: inherit;">
                    <v-btn icon>
                        <v-icon>mdi-home</v-icon>
                    </v-btn>
                </a>
                <a href="/cart.html" style="text-decoration: none; color: inherit;">
                    <v-btn icon>
                        <v-icon>mdi-cart</v-icon>
                        <span>{{ totalItemsInCart }}</span>
                    </v-btn>
                </a>
            </v-app-bar>

            <v-tabs v-model="tab" grow>
                <v-tab value="inventory">Inventaire</v-tab>
                <v-tab value="cart">Panier</v-tab>
            </v-tabs>
            <v-main>
                <v-container fluid>
                    <v-window v-model="tab">
                        <transition name="fade" mode="out-in">
                            <v-window-item value="cart">
                                <v-card class="cart pa-3">
                                    <h2 class="text-warning mb-3">Panier</h2>
                                    <v-list v-if="cart.length > 0">
                                        <v-list-item v-for="item in cart" :key="item.blueprintId">
                                            <template v-slot:prepend>
                                                <img :src="item.hovered ? item.hoverImage : item.originalImage" 
                                                     :alt="item.name" 
                                                     class="cart-item-image"
                                                     @mouseover="item.hovered = true"
                                                     @mouseout="item.hovered = false">
                                            </template>
                                            <v-list-item-title>{{ item.name }} - {{ item.price }} €</v-list-item-title>
                                            <template v-slot:append>
                                                <select v-model="item.quantity" @change="updateQuantity(item.blueprintId, item.quantity)">
                                                    <option v-for="qty in item.maxQuantity" :value="qty">{{ qty }}</option>
                                                </select>
                                            </template>
                                        </v-list-item>
                                    </v-list>
                                    <v-alert v-else type="info" class="mt-3">Votre panier est vide.</v-alert>
                                    <v-card-text class="mt-3" v-if="cart.length > 0">Total: <span class="font-weight-bold">{{ cartTotal.toFixed(2) }}</span> €</v-card-text>
                                    <v-text-field
                                        v-model="pseudo"
                                        label="Votre pseudo"
                                        outlined
                                        dense
                                        class="mt-3"
                                        v-if="cart.length > 0"
                                    ></v-text-field>
                                    <v-btn color="error" block @click="clearCart" v-if="cart.length > 0">Vider le panier</v-btn>
                                    <v-btn color="success" block class="mt-3" @click="validateCart" v-if="cart.length > 0">Valider le panier</v-btn>
                                </v-card>
                            </v-window-item>
                        </transition>
                    </v-window>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.js"></script>
    <script type="module">
        import { fetchFrenchPokemonName, generateUserId, saveCartToLocalStorage, getCartFromLocalStorage, saveCartToSupabase, validateCart } from './shared.js';

        const { createApp, ref, reactive, computed } = Vue;
        const vuetify = Vuetify.createVuetify({
            theme: {
                defaultTheme: 'dark',
                themes: {
                    dark: {
                        colors: {
                            primary: '#FFD700',
                            secondary: '#1E1E1E',
                            background: '#121212',
                            surface: '#1E1E1E',
                            error: '#FF5252',
                            info: '#2196F3',
                            success: '#4CAF50',
                            warning: '#FFC107',
                        },
                    },
                },
            },
        });

        const app = createApp({
            setup() {
                const cart = ref(getCartFromLocalStorage().map(item => ({
                    ...item,
                    hovered: false,
                    originalImage: item.image,
                    hoverImage: item.hoverImage || item.image,
                })));
                const userId = ref(generateUserId());
                const tab = ref('cart');
                const pseudo = ref('');
                const snackbar = reactive({
                    show: false,
                    message: '',
                    color: 'success',
                });

                function showNotification(message, color = 'success') {
                    snackbar.message = message;
                    snackbar.color = color;
                    snackbar.show = true;
                    setTimeout(() => {
                        snackbar.show = false;
                    }, 3000);
                }

                function updateQuantity(blueprintId, quantity) {
                    const item = cart.value.find(item => item.blueprintId === blueprintId);
                    if (item) {
                        item.quantity = quantity;
                        saveCartToLocalStorage(cart.value);
                    }
                }

                function clearCart() {
                    cart.value = [];
                    showNotification("Le panier a été vidé.", 'info');
                    saveCartToLocalStorage(cart.value);
                }

                async function validateCart() {
                    try {
                        if (cart.value.length === 0) {
                            showNotification("Le panier est vide.", 'error');
                            return;
                        }

                        const result = await validateCart(userId.value, cart.value, pseudo.value);
                        if (result.success) {
                            showNotification(result.message, 'success');
                            clearCart();
                            pseudo.value = '';
                        } else {
                            showNotification(result.message, 'error');
                        }
                    } catch (error) {
                        console.error("Erreur lors de la validation du panier :", error);
                        showNotification("Une erreur s'est produite lors de la validation du panier.", 'error');
                    }
                }

                const cartTotal = computed(() => cart.value.reduce((total, item) => total + item.price * item.quantity, 0));
                const totalItemsInCart = computed(() => cart.value.reduce((total, item) => total + item.quantity, 0));

                return {
                    cart,
                    tab,
                    pseudo,
                    snackbar,
                    cartTotal,
                    totalItemsInCart,
                    updateQuantity,
                    clearCart,
                    validateCart,
                    showNotification,
                };
            }
        });

        app.use(vuetify);
        app.mount('#app');
    </script>
</body>
</html>
